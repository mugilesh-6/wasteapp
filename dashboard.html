<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Waste Management App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>#map { height: 300px; width: 100%; margin-top: 10px; }</style>
</head>
<body>
<div class="container mt-5">
    <h1>Welcome, {{ user.get('name') }}</h1>
    <p>Address: {{ user.get('address') }}</p>
    <p><strong>Role:</strong> {{ user.get('role', 'Citizen') }}</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if user.get('role') == 'user' %}
    <form method="POST" enctype="multipart/form-data">
        <button type="submit" name="collect_home" class="btn btn-primary mb-3">Collect from My Home</button>
        <button type="button" id="show_common_form" class="btn btn-success mb-3 ms-2">Collect from Common Place</button>

        <div id="common_place_section" style="display: none;" class="mt-3">
            <label>Common Place Name:</label>
            <input type="text" name="common_place" class="form-control mb-2" placeholder="Enter common place name">

            <label>Upload Image:</label>
            <input type="file" name="image" class="form-control mb-2">

            <label>Select Location on Map:</label>
            <div id="map"></div>
            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lng" id="lng">

            <button type="submit" name="collect_common" class="btn btn-success mt-2">Submit Request</button>
            <button type="button" id="cancel_common_form" class="btn btn-secondary mt-2 ms-2">Cancel</button>
        </div>
    </form>
    {% endif %}

    <h3 class="mt-5">My Waste Requests</h3>
    <table class="table table-bordered mt-3">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Type</th>
                <th>Address / Common Place</th>
                <th>Image</th>
                <th>Status</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody>
            {% for r in requests %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ r.type }}</td>
                <td>{{ r.address if r.type=='home' else r.common_place }}</td>
                <td>{% if r.type=='common' and r.image %}<a href="{{ r.image }}" target="_blank">View</a>{% else %} N/A {% endif %}</td>
                <td>{{ r.status }}</td>
                <td>{{ r.timestamp.strftime('%Y-%m-%d %H:%M:%S') if r.timestamp else '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="{{ url_for('training') }}" class="btn btn-info mt-4">Training</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger mt-4 ms-2">Logout</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const showBtn = document.getElementById('show_common_form');
const cancelBtn = document.getElementById('cancel_common_form');
const commonSection = document.getElementById('common_place_section');
showBtn?.addEventListener('click', ()=>{ commonSection.style.display='block'; });
cancelBtn?.addEventListener('click', ()=>{ commonSection.style.display='none'; });

// Leaflet map
var indiaBounds = [[6.5546079, 68.1113787], [35.6745457, 97.395561]];
var map = L.map('map', { maxBounds: indiaBounds, maxBoundsViscosity: 1.0 }).setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd', maxZoom: 19
}).addTo(map);

var marker;
if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
        var lat = pos.coords.latitude, lng = pos.coords.longitude;
        lat = Math.max(6.5546, Math.min(35.6745, lat));
        lng = Math.max(68.1113, Math.min(97.3955, lng));
        map.setView([lat, lng], 13);
        marker = L.marker([lat, lng], {draggable:true}).addTo(map);
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
        marker.on('dragend', function(e){
            var p = e.target.getLatLng();
            document.getElementById('lat').value = p.lat;
            document.getElementById('lng').value = p.lng;
        });
    });
}

map.on('click', function(e){
    var lat = e.latlng.lat, lng = e.latlng.lng;
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;
    if(marker){ marker.setLatLng(e.latlng); }
    else{
        marker = L.marker(e.latlng, {draggable:true}).addTo(map);
        marker.on('dragend', function(e){
            var p = e.target.getLatLng();
            document.getElementById('lat').value = p.lat;
            document.getElementById('lng').value = p.lng;
        });
    }
});
</script>
</body>
</html>
