<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Waste Management App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>#map{height:400px;width:100%;margin-top:20px;}</style>
</head>
<body>
<div class="container mt-5">
    <h1>Admin Dashboard</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show mt-3">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <h3 class="mt-4">Users</h3>
    <table class="table table-bordered mt-3">
        <thead class="table-dark">
            <tr>
                <th>#</th><th>Name</th><th>Username</th><th>Address</th>
                <th>Training Completed</th><th>Role</th><th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for u in all_users %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ u.name }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.address }}</td>
                <td>{{ 'Yes' if u.completed else 'No' }}</td>
                <td>{{ u.role }}</td>
                <td>
                    {% if u.role == 'user' %}
                        <a href="{{ url_for('update_role', user_id=u._id, new_role='worker') }}" class="btn btn-success btn-sm">Promote to Worker</a>
                    {% elif u.role == 'worker' %}
                        <a href="{{ url_for('update_role', user_id=u._id, new_role='user') }}" class="btn btn-warning btn-sm">Demote to User</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 class="mt-5">Waste Requests</h3>
    <table class="table table-bordered mt-3">
        <thead class="table-dark">
            <tr>
                <th>#</th><th>User</th><th>Type</th><th>Address/Common Place</th>
                <th>Image</th><th>Status</th><th>Timestamp</th><th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for r in all_requests %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ r.user_name }}</td>
                <td>{{ r.type }}</td>
                <td>{{ r.address if r.type=='home' else r.common_place }}</td>
                <td>{% if r.type=='common' and r.image %}<a href="{{ r.image }}" target="_blank">View</a>{% else %}N/A{% endif %}</td>
                <td>{{ r.status }}</td>
                <td>{{ r.timestamp.strftime("%Y-%m-%d %H:%M:%S") if r.timestamp else '' }}</td>
                <td>
                     <a href="{{ url_for('update_request', request_id=r._id, action='approve') }}" class="btn btn-success btn-sm">Approve</a>
                     <a href="{{ url_for('update_request', request_id=r._id, action='reject') }}" class="btn btn-danger btn-sm">Reject</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 class="mt-5">Reported Common Place Locations</h3>
    <div id="map"></div>

    <a href="{{ url_for('home') }}" class="btn btn-secondary mt-3">Home</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger mt-3">Logout</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var indiaBounds = [[6.5546079, 68.1113787], [35.6745457, 97.395561]];
var map = L.map('map', { maxBounds: indiaBounds, maxBoundsViscosity: 1.0 }).setView([20.5937,78.9629],5);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; OSM &copy; CARTO', subdomains:'abcd', maxZoom:19
}).addTo(map);

{% for r in all_requests %}
    {% if r.type=='common' and r.lat and r.lng %}
        L.marker([{{ r.lat }}, {{ r.lng }}]).addTo(map)
        .bindPopup("{{ r.common_place }} ({{ r.user_name }})");
    {% endif %}
{% endfor %}
</script>
</body>
</html>
